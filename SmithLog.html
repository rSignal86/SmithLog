<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SmithLog – Universal Cabrillo to ADIF (modified)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --accent:#00ff41;
        --accent-strong:#00ff80;
        --bg:#000;
        --card:#111;
        --warning:#ffaa00;
        --warning-bg:#332200;
        --update:#ff6600;
    }
    body {background:var(--bg); color:#fff; font-family:'Segoe UI',sans-serif; margin:0; padding:15px; text-align:center;}
    h1 {font-family:'Inconsolata',monospace; color:var(--accent-strong); font-size:40px; text-shadow:0 0 10px #0f0; margin:18px 0 8px;}
    h2 {color:#aaa; margin:5px 0 20px; font-size:18px;}

    /* EDIT HERE TO CHANGED THE WITH OF THE PROGRAM */
    .container {max-width:1500px; margin:0 auto;}

    /* toolbar: narrower and centered; buttons reduced padding to make them less wide */
    .toolbar {
        display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center;
        margin:18px 0 12px 0; background:#001100; padding:8px; border-radius:10px; border:2px solid var(--accent);
        max-width:100%; width:100%; box-sizing:border-box;
    }
    .upload-wrapper {margin-right:auto;}
    #uploadBtn {background:#ff8c00; font-size:15px; padding:8px 14px;}
    button {padding:8px 14px; font-size:15px; border:none; border-radius:8px; cursor:pointer; color:#000; font-weight:bold;}
    #analyzeBtn   {background:#00ccff;}
    #generateBtn  {background:#28a745;}
    #clearBtn     {background:#dc3545;}
    #consoleBtn   {background:#9933ff; color:#fff;}
    #helpBtn      {background:#00b7eb; color:#fff;}
    button:hover {transform:scale(1.03);}
    button:disabled {opacity:0.6; cursor:not-allowed;}

    /* Make the textarea the same visible width as the toolbar by constraining with same max-width */
    .inputWrapper {max-width:100%; margin:0 auto;}
    textarea {width:100%; height:260px; padding:12px; background:#222; color:#fff; border:2px solid #444; border-radius:10px; font-family:'Inconsolata',monospace; font-size:16px; margin:12px 0; box-sizing:border-box;}

    .inputHeader {font-size:20px; color:var(--accent-strong); margin:28px 0 12px; font-weight:bold; text-align:center;}

    .global-fields {
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap:12px;
        margin:20px auto;
        max-width: 900px;
    }
    .global-field label {display:block; margin-bottom:6px; color:var(--accent); font-weight:bold; font-size:14px;}
    .global-field input, .global-field select {width:80%; padding:10px; background:#222; color:#fff; border:2px solid #666; border-radius:8px; font-size:14px;}

    table {width:100%; max-width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; font-family:'Inconsolata',monospace; font-size:14px;}
    th {background:#002200; padding:0; position:relative; border:2px solid var(--accent); white-space:nowrap;}
    td {padding:7px 6px; background:#0a0a0a; text-align:center; border:1px solid #333; color:#ddd; font-size:13px;}
    tr:hover td {background:#111;}
    td[contenteditable="true"] {background:#001a00; cursor:text; color:#ff0;}
    td[contenteditable="true"]:focus {outline:2px solid var(--accent-strong);}

    .title-box {display:block; padding:8px 8px; font-weight:bold; color:var(--accent-strong); cursor:pointer; text-align:center; background:#001100; height:100%; box-sizing:border-box; font-size:13px;}
    .title-box:hover {background:#002200;}
    .title-box.active {background:#003300; color:#fff;}
    .title-box.unknown {background:var(--warning-bg); color:var(--warning);}
    .dropdown {display:none; position:absolute; top:100%; left:0; width:100%; max-height:240px; overflow-y:auto; background:#001100; border:2px solid var(--accent); border-top:none; z-index:100;}
    .dropdown option {padding:10px; color:#88ff88; cursor:pointer; font-size:14px;}
    .dropdown option:hover {background:#003300; color:#fff;}
    .autoTag {position:absolute; top:4px; right:6px; font-size:11px; color:#00ff00; background:#000; padding:3px 6px; border-radius:5px; font-weight:bold;}

    #consoleOutput {background:#000; color:#0f0; font-family:'Inconsolata',monospace; font-size:13px; padding:10px; margin:14px 0; border:2px solid #004400; border-radius:8px; height:120px; overflow-y:auto; text-align:left; display:none;}

    /* Help modal — smaller and scrollable when content grows */
    #helpModal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:1000; justify-content:center; align-items:center; padding:20px; box-sizing:border-box;}
    #helpContent {background:#001100; padding:20px; border-radius:12px; border:2px solid var(--accent); max-width:700px; width:100%; font-size:16px; line-height:1.5; color:#ddd; max-height:72vh; overflow-y:auto;}
    #helpContent h3 {color:var(--accent-strong); margin-top:18px;}
    #closeHelp {float:right; font-size:24px; cursor:pointer; color:#aaa;}
    #closeHelp:hover {color:#fff;}

    footer {margin-top:40px; color:#888; font-size:14px; position:relative;}
    #norwayBadge {height:40px; animation: wave 7s ease-in-out infinite; cursor:help;}
    #norwayBadge[title]:hover::after {content: attr(title); position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); background: #001100; color:#00ff80; padding:8px 12px; border-radius:8px; border:2px solid var(--accent); white-space:nowrap; font-size:13px; z-index:1000;}
    #versionStatus {margin-top: 8px; font-family: 'Inconsolata', monospace; font-size: 13px; color:#00ff80;}
    #versionCheckStatus {margin-left: 8px; font-weight: bold;}
    @keyframes wave {0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}
</style>
</head>
<body>
<div class="container">
    <h1>SmithLog – Universal Cabrillo to ADIF</h1>
    <h2>Made With ♥ from a ham to a ham</h2>

    <div class="toolbar" role="toolbar" aria-label="Main toolbar">
        <div class="upload-wrapper">
            <button id="uploadBtn">Upload .log / .txt</button>
            <input type="file" id="fileInput" accept=".log,.txt" style="display:none">
        </div>
        <button id="analyzeBtn">Analyze Cabrillo [F4]</button>
        <button id="generateBtn" disabled>Generate ADIF [F10]</button>
        <button id="clearBtn">Clear All [Esc]</button>
        <button id="consoleBtn">Console</button>
        <button id="helpBtn">Help</button>
    </div>

    <div id="consoleOutput" aria-live="polite"></div>

    <div class="inputWrapper">
        <div class="inputHeader">Paste your Cabrillo log below</div>
        <textarea id="cabrilloInput" placeholder="START-OF-LOG: 3.0..."></textarea>
    </div>

    <div id="globalSettingsArea" style="display:none;">
        <div class="inputHeader">Global optional settings</div>
        <div class="global-fields" id="globalFieldsContainer">
            <div class="global-field">
                <label>Contest (auto-detected)</label>
                <select id="contestSelect"><option value="">– Detecting... –</option></select>
            </div>
            <div class="global-field">
                <label>Global Comment</label>
                <input type="text" id="globalComment" placeholder="e.g. Home station, 100W, dipole">
            </div>
            <div class="global-field">
                <label>TX Power (watts)</label>
                <input type="text" id="globalTxPower" placeholder="e.g. 100">
            </div>
            <div class="global-field">
                <label>K-Index</label>
                <input type="text" id="globalKIndex" placeholder="e.g. 3">
            </div>
            <div class="global-field">
                <label>A-Index</label>
                <input type="text" id="globalAIndex" placeholder="e.g. 12">
            </div>
            <div class="global-field">
                <label>SFI</label>
                <input type="text" id="globalSFI" placeholder="e.g. 145">
            </div>
        </div>
    </div>

    <div id="mappingArea" style="display:none;">
        <div class="inputHeader">QSO Preview & Column Mapping (all QSOs shown)</div>
        <table id="previewTable">
            <thead id="columnHeaders"></thead>
            <tbody id="previewRows"></tbody>
        </table>
    </div>

    <footer>
        <div style="display:flex; align-items:center; justify-content:center; gap:22px; flex-wrap:wrap; padding:18px 0; font-size:18px;">
            <img id="norwayBadge" src="https://raw.githubusercontent.com/rSignal86/smithlog/main/productofnorway.png"
                 alt="Product of Norway" title="Made in Norway – 73 de LB6QJ and GROK" style="height:58px;">

            <a href="https://github.com/rSignal86/smithlog" target="_blank" style="color:#00ff80; font-weight:bold; text-decoration:none; font-size:20px;">
                SmithLog – GitHub Repository
            </a>

            <div id="versionStatus" style="font-family:'Inconsolata', monospace; font-size:18px; color:#00ff80;">
                <span id="versionCheckStatus">Checking for updates...</span>
            </div>
        </div>
    </footer>
</div>

<!-- Help Modal -->
<div id="helpModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="helpContent">
        <span id="closeHelp">X</span>
        <h2 style="color:var(--accent-strong); margin-top:0;">SmithLog – How to Use</h2>
        <p>This tool follows ADIF Standard Version 3.1.6</p>
        <h3>1. Load your log</h3>
        <p>Paste or upload your Cabrillo file.</p>
        <h3>2. Click "Analyze Cabrillo" (F4)</h3>
        <p>SmithLog auto-detects contest and columns.</p>
        <h3>3. Contest detection</h3>
        <p>If your contest is known → correct <code>CONTEST_ID</code> is set automatically.<br>
        If not known → contest name is added to comment.</p>
        <h3>4. Check column mapping</h3>
        <p>Click any header to change field, the yellow is marked as UNKNOWN that you click to assign an ADIF standard to Column.</p>
        <p>Use STX for serial exchange you send </p>
        <p>Use SRX for serial exchange you receive </p>
        <p>Use STX_STRING for contest exchange you send (text) </p>
        <p>Use SRX_STRING for contest exchange you receive (text) </p>
        <h3>5. Generate ADIF (F10)</h3>
        <p>Download ready for upload to QRZ.com</p>
        <p>Good luck – 73 de LB6QJ, GROK and ChatGPT!</p>
    </div>
</div>

<script>
/*
  SCRIPT STRUCTURE:
  - setupDOMReferences()  -> collect DOM nodes
  - init()                -> initialization flow
  - loadContestDatabase() -> attempt to load contest mapping JSON (optional)
  - analyzeCabrillo()     -> parse the pasted file and prepare UI
  - renderHelpers()       -> build headers and preview table
  - generateAdif()        -> build and download ADIF (no remote HTML download)
  - checkForUpdate()      -> version check using GitHub Releases API (ONLY parses JSON & PNG, NEVER auto-downloads HTML)
*/

document.addEventListener('DOMContentLoaded', () => {
    const dom = setupDOMReferences();
    // state
    let rawQsoLines = [], columnMapping = [], myCallsign = "YOURCALL", sampleColumns = [], qsoOverrides = new Map();
    let rawContestName = "", detectedContestId = null;
    let contestDatabase = {};

    init();

    // ----------------- DOM / setup -----------------
    function setupDOMReferences() {
        return {
            input: document.getElementById('cabrilloInput'),
            mappingArea: document.getElementById('mappingArea'),
            globalSettingsArea: document.getElementById('globalSettingsArea'),
            globalFieldsContainer: document.getElementById('globalFieldsContainer'),
            contestSelect: document.getElementById('contestSelect'),
            globalComment: document.getElementById('globalComment'),
            headers: document.getElementById('columnHeaders'),
            preview: document.getElementById('previewRows'),
            globalTxPower: document.getElementById('globalTxPower'),
            globalK: document.getElementById('globalKIndex'),
            globalA: document.getElementById('globalAIndex'),
            globalSFI: document.getElementById('globalSFI'),
            btnGenerate: document.getElementById('generateBtn'),
            consoleOutput: document.getElementById('consoleOutput'),
            helpModal: document.getElementById('helpModal'),
            closeHelp: document.getElementById('closeHelp'),
            versionCheckStatus: document.getElementById('versionCheckStatus')
        };
    }

    //snitcher
    function log(msg) {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toISOString().slice(11,19)}] ${msg}`;
        dom.consoleOutput.appendChild(line);
        if (dom.consoleOutput.style.display === 'block') dom.consoleOutput.scrollTop = dom.consoleOutput.scrollHeight;
    }

    // ----------------- OS Booting -----------------
    async function init() {
        attachUIEvents();
	log('ohh snap snithcher button has been pressed ');
        log('SmithLogOS is booting.......');

        // Load optional contest database but allow offline mode
        await loadContestDatabase();
        populateContestDropdown();

        // Start safe version check (GitHub Releases).
        checkForUpdate();
        setInterval(checkForUpdate, 720 * 60 * 1000);
    }

    // ----------------- load optional contest DB -----------------
    async function loadContestDatabase() {
        try {
            const res = await fetch('https://raw.githubusercontent.com/rSignal86/smithlog/main/QRZContestID.json');
            if (!res.ok) throw new Error('Contest DB not available');
            const data = await res.json();
            contestDatabase = data.contests || {};
            log(`Contest database loaded – ${Object.keys(contestDatabase).length} contests`);
        } catch (err) {
            log('Contest database offline – running in basic mode');
            contestDatabase = {};
        }
    }

    function populateContestDropdown(selected = "") {
        dom.contestSelect.innerHTML = '<option value="">– Manual selection –</option>';
        Object.keys(contestDatabase).sort().forEach(id => {
            const opt = document.createElement('option'); opt.value = id; opt.textContent = `${id} – ${contestDatabase[id]}`;
            if (id === selected) opt.selected = true;
            dom.contestSelect.appendChild(opt);
        });
    }

    // ----------------- attach UI events -----------------
    function attachUIEvents() {
        document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0]; if (!file) return;
            log(`Loading: ${file.name}`);
            const reader = new FileReader();
            reader.onload = ev => { dom.input.value = ev.target.result; log('File loaded'); };
            reader.readAsText(file);
        });

        document.getElementById('analyzeBtn').addEventListener('click', analyzeCabrillo);
        dom.btnGenerate.addEventListener('click', generateAdif);
        document.getElementById('clearBtn').addEventListener('click', () => confirm('Clear everything?') && location.reload());

        document.getElementById('consoleBtn').onclick = () => {
            const visible = dom.consoleOutput.style.display === 'block';
            dom.consoleOutput.style.display = visible ? 'none' : 'block';
            if (!visible) dom.consoleOutput.scrollTop = dom.consoleOutput.scrollHeight;
        };

        document.getElementById('helpBtn').onclick = () => { dom.helpModal.style.display = 'flex'; dom.helpModal.setAttribute('aria-hidden','false'); };
        dom.closeHelp.onclick = () => { dom.helpModal.style.display = 'none'; dom.helpModal.setAttribute('aria-hidden','true'); };
        dom.helpModal.onclick = (e) => { if (e.target === dom.helpModal) { dom.helpModal.style.display = 'none'; dom.helpModal.setAttribute('aria-hidden','true'); } };

        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.title-box').forEach(b => b.classList.remove('active'));
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'F4') { e.preventDefault(); document.getElementById('analyzeBtn').click(); }
            if (e.key === 'F10' && !dom.btnGenerate.disabled) { e.preventDefault(); dom.btnGenerate.click(); }
            if (e.key === 'Escape') document.getElementById('clearBtn').click();
        });
    }

    // ----------------- analyze CABRILLO input -----------------
    function analyzeCabrillo() {
        const text = dom.input.value.trim();
        if (!text) return alert('Paste or upload a Cabrillo log first!');

        const lines = text.split('\n');
        rawQsoLines = lines.filter(l => l.trim().startsWith('QSO:'));
        if (rawQsoLines.length === 0) { log('ERROR: No QSO lines found'); return alert('No QSO lines found!'); }
        log(`Found ${rawQsoLines.length} QSOs – showing ALL`);

        lines.forEach(l => {
            if (l.trim().startsWith('CALLSIGN:')) myCallsign = l.split(':')[1].trim();
            if (l.trim().startsWith('CONTEST:')) rawContestName = l.split(':')[1].trim();
        });

        detectedContestId = null;
        if (rawContestName && Object.keys(contestDatabase).length > 0) {
            const norm = rawContestName.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            detectedContestId = Object.keys(contestDatabase).find(id => {
                const name = contestDatabase[id];
                return id.toUpperCase() === norm || (name && name.toUpperCase().includes(norm));
            });
        }

        if (detectedContestId) {
            dom.contestSelect.value = detectedContestId; log(`Contest auto-detected: ${detectedContestId}`);
        } else if (rawContestName) {
            if (!dom.globalComment.value) dom.globalComment.value = rawContestName; log(`Contest not found, crap: "${rawContestName}" → oh well i added it to comment`);
        }

        sampleColumns = rawQsoLines[0].trim().split(/\s+/).slice(1);
        columnMapping = new Array(sampleColumns.length).fill('UNKNOWN');
        qsoOverrides = new Map();

        buildColumnHeaders();
        renderAllQSOs();

        dom.globalSettingsArea.style.display = 'block';
        dom.globalFieldsContainer.style.display = 'grid';
        dom.mappingArea.style.display = 'block';
        dom.btnGenerate.disabled = false;

        log(`Analysis complete – ${rawQsoLines.length} QSOs displayed`);
    }

    // ----------------- header + preview rendering -----------------
    const TOOLTIPS = {
        "UNKNOWN": "Not mapped – click to assign",
        "CALL": "Other station's callsign",
        "QSO_DATE": "Date (YYYY-MM-DD → YYYYMMDD)",
        "TIME_ON": "Start time (HHMM or HHMMSS)",
        "FREQ": "Frequency in kHz → converted to MHz",
        "MODE": "Mode (SSB, CW, RTTY, FT8 etc.)",
        "RST_SENT": "Your sent report",
        "RST_RCVD": "Received report",
        "STX": "Your sent serial number",
        "SRX": "Received serial number",
        "STX_STRING": "Your sent exchange (text)",
        "SRX_STRING": "Received exchange (text)",
        "NAME": "Operator name",
        "GRID": "Maidenhead locator",
        "STATE": "US state / province",
        "MY_CALLSIGN": "Your callsign",
        "TX_PWR": "Your TX power"
    };

    function buildColumnHeaders() {
        dom.headers.innerHTML = '';
        const tr = document.createElement('tr');
        sampleColumns.forEach((_, i) => {
            const th = document.createElement('th');
            const box = document.createElement('div'); box.className = 'title-box';
            let guessed = i===0 ? 'FREQ' : i===1 ? 'MODE' : i===2 ? 'QSO_DATE' : i===3 ? 'TIME_ON' : i===4 ? 'MY_CALLSIGN' : 'UNKNOWN';
            columnMapping[i] = guessed; box.textContent = guessed;
            if (guessed === 'UNKNOWN') box.classList.add('unknown');

            const dropdown = document.createElement('select'); dropdown.className = 'dropdown'; dropdown.size = 10;
            Object.keys(TOOLTIPS).forEach(field => {
                const opt = document.createElement('option'); opt.value = field; opt.textContent = field; opt.title = TOOLTIPS[field];
                if (field === guessed) opt.selected = true; dropdown.appendChild(opt);
            });

            dropdown.onchange = () => {
                columnMapping[i] = dropdown.value; box.textContent = dropdown.value; box.classList.toggle('unknown', dropdown.value === 'UNKNOWN'); dropdown.style.display = 'none'; box.classList.remove('active');
            };

            box.onclick = e => {
                e.stopPropagation();
                document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
                document.querySelectorAll('.title-box').forEach(b => b.classList.remove('active'));
                box.classList.add('active'); dropdown.style.display = 'block'; dropdown.focus();
            };

            if (guessed !== 'UNKNOWN') {
                const auto = document.createElement('span'); auto.className = 'autoTag'; auto.textContent = 'AUTO'; th.appendChild(auto);
            }

            th.appendChild(box); th.appendChild(dropdown); tr.appendChild(th);
        });

        ['Comment','K-Index','A-Index','SFI'].forEach(title => { const th = document.createElement('th'); th.textContent = title; th.style.background = '#003300'; tr.appendChild(th); });
        dom.headers.appendChild(tr);
    }

    function renderAllQSOs() {
        dom.preview.innerHTML = '';
        rawQsoLines.forEach((line, idx) => {
            const fields = line.trim().split(/\s+/).slice(1);
            const row = document.createElement('tr');
            fields.forEach(f => { const td = document.createElement('td'); td.textContent = f; row.appendChild(td); });
            ['Comment','K-Index','A-Index','SFI'].forEach(key => {
                const td = document.createElement('td'); td.contentEditable = true; const ov = qsoOverrides.get(idx) || {}; td.textContent = ov[key.toLowerCase()] || '';
                td.onblur = () => { const val = td.textContent.trim(); if (!qsoOverrides.has(idx)) qsoOverrides.set(idx, {}); if (val) qsoOverrides.get(idx)[key.toLowerCase()] = val; else delete qsoOverrides.get(idx)[key.toLowerCase()]; };
                row.appendChild(td);
            });
            dom.preview.appendChild(row);
        });
    }

    // ----------------- generate ADIF (no remote HTML download) -----------------
    function generateAdif() {
        log(`Generating ADIF with ${rawQsoLines.length} QSOs...`);
        const selectedContestId = dom.contestSelect.value || detectedContestId;

        let adif = `SmithLog GHv1.1 Export\n<ADIF_VER:5>3.1.4\n<CREATED_TIMESTAMP:${new Date().toISOString().replace(/[-:T.]/g,'').slice(0,14)}>#\n<PROGRAMID:8>SmithLog\n<PROGRAMVERSION:10>GHv1.1\n<EOH>\n\n`;

        let exported = 0;
        rawQsoLines.forEach((line, idx) => {
            const parts = line.trim().split(/\s+/);
            if (parts[0] !== 'QSO:') return;
            const values = parts.slice(1);
            const record = {};

            values.forEach((val, i) => {
                const field = columnMapping[i]; if (!field || field === 'UNKNOWN') return; let cleaned = val;
                if (field === 'FREQ') { const n = parseFloat(val); if (!isNaN(n)) cleaned = (n >= 1000 ? (n/1000) : n).toFixed(3).replace(/\.?0+$/, ''); }
                if (field === 'MODE') { const m = {PH:'SSB',RY:'RTTY',DG:'FT8',FT8:'FT8',FT4:'FT4',CW:'CW'}[val.toUpperCase()]; cleaned = m || val.toUpperCase(); }
                if (field === 'QSO_DATE') cleaned = val.replace(/-/g, '');
                if (field === 'TIME_ON') cleaned = val.padEnd(6,'0').slice(0,6);
                if (field === 'MY_CALLSIGN') cleaned = myCallsign;
                record[field] = cleaned;
            });

            if (selectedContestId) record.CONTEST_ID = selectedContestId;

            const ov = qsoOverrides.get(idx) || {};
            const comment = [dom.globalComment.value.trim(), ov.comment].filter(Boolean).join(' | ');
            if (comment) record.COMMENT = comment;
            if (dom.globalTxPower.value.trim() || ov.txpwr) record.TX_PWR = ov.txpwr || dom.globalTxPower.value.trim();
            if (dom.globalK.value.trim() || ov.k) record.K_INDEX = ov.k || dom.globalK.value.trim();
            if (dom.globalA.value.trim() || ov.a) record.A_INDEX = ov.a || dom.globalA.value.trim();
            if (dom.globalSFI.value.trim() || ov.sfi) record.SFI = ov.sfi || dom.globalSFI.value.trim();

            record.CALL ||= 'NOCALL'; record.QSO_DATE ||= '20000101'; record.TIME_ON ||= '000000'; record.MODE ||= 'SSB';

            let lineOut = '';
            Object.keys(record).sort().forEach(k => lineOut += `<${k}:${record[k].length}>${record[k]} `);
            adif += lineOut + '<EOR>\n';
            exported++;
        });

        const blob = new Blob([adif], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `SmithLog_${new Date().toISOString().slice(0,10)}.adi`; a.click(); URL.revokeObjectURL(url);

        log(`ADIF generated – ${exported} QSOs exported${selectedContestId ? ` (CONTEST_ID: ${selectedContestId})` : ''}`);
    }

    // ----------------- safe update check via GitHub Releases API -----------------

    async function checkForUpdate() {
        const CURRENT_VERSION = 'GHv1.1';
        const statusElement = dom.versionCheckStatus;
        const apiUrl = 'https://api.github.com/repos/rSignal86/smithlog/releases/latest';
        const repoUrl = 'https://github.com/rSignal86/smithlog';

        log(`[VERSION CHECK] Querying GitHub Releases API: ${apiUrl}`);
        try {
            const res = await fetch(apiUrl, { cache: 'no-store' });
            if (!res.ok) throw new Error(`GitHub API error ${res.status}`);
            const json = await res.json();
            const latestTag = (json.tag_name || json.name || '').toString();
            log(`[VERSION CHECK] Latest release tag/name: ${latestTag}`);

            if (!latestTag) throw new Error('No release tag/name found');

            if (latestTag === CURRENT_VERSION) {
                statusElement.innerHTML = '– yeee, latest version is used';
                statusElement.style.color = '#00ff80';
                log('[VERSION CHECK] I told the user on the footer that the user is using the lates stuff');
                return;
            }

            // New release available — inspect assets but do NOT auto-download HTML files
            statusElement.innerHTML = `– You are lucky now:`;
            statusElement.style.color = '#ff6600';
            log(`[VERSION CHECK] Update available: ${latestTag}`);

            const assets = Array.isArray(json.assets) ? json.assets : [];
            log(`[VERSION CHECK] Release contains ${assets.length} assets — will only consider .json and .png files`);

            // Find json and png assets (if any)
            const jsonAsset = assets.find(a => a.name && a.name.toLowerCase().endsWith('.json'));
            const pngAsset = assets.find(a => a.name && a.name.toLowerCase().endsWith('.png'));

            if (jsonAsset) {
                log(`[VERSION CHECK] Found JSON asset: ${jsonAsset.name} — fetching and parsing`);
                try {
                    const r = await fetch(jsonAsset.browser_download_url, { cache: 'no-store' });
                    if (r.ok) {
                        const parsed = await r.json();
                        // We only parse and log the high-level info — do not execute any instructions inside
                        log(`[VERSION CHECK] Parsed JSON asset successfully (keys: ${Object.keys(parsed).slice(0,8).join(', ')})`);
                    } else {
                        log(`[VERSION CHECK] Failed to fetch JSON asset: HTTP ${r.status}`);
                    }
                } catch (e) {
                    log(`[VERSION CHECK] Error fetching JSON asset: ${e.message}`);
                }
            } else {
                log('[VERSION CHECK] No JSON asset found in release');
            }

            if (pngAsset) {
                log(`[VERSION CHECK] Found PNG asset: ${pngAsset.name} — fetching as blob for preview (no execution)`);
                try {
                    const r = await fetch(pngAsset.browser_download_url, { cache: 'no-store' });
                    if (r.ok) {
                        const blob = await r.blob();
                        const previewUrl = URL.createObjectURL(blob);
                        // We don't insert it into DOM automatically, but provide a console message and keep the URL for optional use
                        log('[VERSION CHECK] PNG asset fetched (preview available in console).');
                        // Revoke after a short delay to avoid leaking resources in long-running sessions
                        setTimeout(() => URL.revokeObjectURL(previewUrl), 60 * 1000);
                    } else {
                        log(`[VERSION CHECK] Failed to fetch PNG asset: HTTP ${r.status}`);
                    }
                } catch (e) {
                    log(`[VERSION CHECK] Error fetching PNG asset: ${e.message}`);
                }
            } else {
                log('[VERSION CHECK] No PNG asset found in release');
            }

            //Respect privacy.
            log('[VERSION CHECK] Completed safe check.');

            // Provide the user a link to the release so they can manually review and download if desired
            statusElement.innerHTML += ` <a href="${repoUrl}/releases/latest" target="_blank" style="color:#ff6600; font-weight:bold; text-decoration:underline;">Click here to download ${latestTag} version</a>`;

        } catch (err) {
            statusElement.innerHTML = '– Update check failed';
            statusElement.style.color = '#888';
            log(`[VERSION CHECK] ❌ Error: ${err.message}`);
        }
    }

});
</script>
</body>
</html>

